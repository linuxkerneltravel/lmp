// Copyright 2024 The LMP Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// https://github.com/linuxkerneltravel/lmp/blob/develop/LICENSE
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// author: luiyanbing@foxmail.com
//
// 用户态使用的宏

#ifndef STACK_ANALYZER_USER
#define STACK_ANALYZER_USER

#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <sys/eventfd.h>
#include <signal.h>
#include <unistd.h>

#include "common.h"

#define _COL_PREFIX "\033["
#define _BLUE _COL_PREFIX "1;34m"
#define _GREEN _COL_PREFIX "1;32m"
#define _RED _COL_PREFIX "1;35m"
#define _ERED _COL_PREFIX "1;31m"
#define _RE _COL_PREFIX "0m"

#define PUT_ERR_REASON \
	fprintf(stderr, _ERED " [%s]\n" _RE, strerror(errno));

#define HINT_ERR(...)                       \
	{                                       \
		fprintf(stderr, _ERED __VA_ARGS__); \
		PUT_ERR_REASON;                     \
	}

#define DEAL_ERR(action, ...)  \
	{                          \
		HINT_ERR(__VA_ARGS__); \
		action;                \
	}

/// @brief 检查错误，若错误成立则打印带原因的错误信息，并执行action
/// @param action cond成立执行的语句
/// @param cond 被检查的条件表达式
/// @param info 要打印的错误信息
#define CHECK_ERR(action, cond, ...) \
	if (cond)                        \
	DEAL_ERR(action, __VA_ARGS__)

/// @brief 检查错误，若错误成立则打印带原因的错误信息并使上层函数返回-1
/// @param cond 被检查的条件表达式
/// @param info 要打印的错误信息
#define CHECK_ERR_RN1(cond, ...) \
	CHECK_ERR(return -1, cond, __VA_ARGS__)

#define BANNER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \
	"\033[38;2;214;165;4m \033[39m\033[38;2;219;159;5m \033[39m\033[38;2;223;152;7m \033[39m\033[38;2;227;146;9m_\033[39m\033[38;2;231;140;12m_\033[39m\033[38;2;234;133;15m_\033[39m\033[38;2;238;127;18m_\033[39m\033[38;2;241;121;21m_\033[39m\033[38;2;243;114;25m \033[39m\033[38;2;246;108;28m_\033[39m\033[38;2;248;102;33m_\033[39m\033[38;2;250;96;37m \033[39m\033[38;2;251;90;41m \033[39m\033[38;2;253;84;46m \033[39m\033[38;2;254;78;51m \033[39m\033[38;2;254;72;56m \033[39m\033[38;2;254;66;62m \033[39m\033[38;2;254;61;67m \033[39m\033[38;2;254;55;73m \033[39m\033[38;2;253;50;79m \033[39m\033[38;2;252;45;85m \033[39m\033[38;2;251;41;91m \033[39m\033[38;2;250;36;97m \033[39m\033[38;2;248;32;103m \033[39m\033[38;2;245;28;109m_\033[39m\033[38;2;243;24;116m_\033[39m\033[38;2;240;20;122m \033[39m\033[38;2;237;17;128m \033[39m\033[38;2;234;14;135m \033[39m\033[38;2;230;11;141m_\033[39m\033[38;2;226;9;147m_\033[39m\033[38;2;222;7;153m_\033[39m\033[38;2;218;5;160m \033[39m\033[38;2;213;4;166m \033[39m\033[38;2;208;2;172m \033[39m\033[38;2;204;1;178m \033[39m\033[38;2;198;1;183m \033[39m\033[38;2;193;1;189m \033[39m\033[38;2;187;1;194m \033[39m\033[38;2;182;1;200m \033[39m\033[38;2;176;2;205m \033[39m\033[38;2;170;3;210m \033[39m\033[38;2;164;4;215m \033[39m\033[38;2;158;6;219m \033[39m\033[38;2;152;7;223m \033[39m\033[38;2;145;10;227m \033[39m\033[38;2;139;12;231m \033[39m\033[38;2;133;15;235m \033[39m\033[38;2;126;18;238m_\033[39m\033[38;2;120;21;241m_\033[39m\033[38;2;114;25;244m \033[39m\033[38;2;107;29;246m \033[39m\033[38;2;101;33;248m \033[39m\033[38;2;95;37;250m \033[39m\033[38;2;89;42;252m \033[39m\033[38;2;83;47;253m \033[39m\033[38;2;77;52;254m \033[39m\033[38;2;71;57;254m \033[39m\033[38;2;66;62;254m \033[39m\033[38;2;60;68;254m \033[39m\033[38;2;55;74;254m \033[39m\033[38;2;50;79;253m \033[39m\033[38;2;45;85;252m \033[39m\033[38;2;40;91;251m \033[39m\033[38;2;36;97;249m \033[39m\033[38;2;31;104;247m \033[39m\033[38;2;27;110;245m \033[39m\033[38;2;24;116;243m \033[39m\033[38;2;20;123;240m \033[39m\033[38;2;17;129;237m \033[39m\033[38;2;14;135;233m \033[39m\033[38;2;11;142;230m\033[39m\n"       \
	"\033[38;2;215;164;4m \033[39m\033[38;2;219;158;5m \033[39m\033[38;2;223;152;7m/\033[39m\033[38;2;227;145;10m \033[39m\033[38;2;231;139;12m_\033[39m\033[38;2;235;133;15m_\033[39m\033[38;2;238;127;18m_\033[39m\033[38;2;241;120;21m/\033[39m\033[38;2;244;114;25m/\033[39m\033[38;2;246;108;29m \033[39m\033[38;2;248;101;33m/\033[39m\033[38;2;250;95;37m_\033[39m\033[38;2;252;89;42m_\033[39m\033[38;2;253;83;47m_\033[39m\033[38;2;254;77;52m_\033[39m\033[38;2;254;71;57m_\033[39m\033[38;2;254;66;62m \033[39m\033[38;2;254;60;68m_\033[39m\033[38;2;254;55;73m_\033[39m\033[38;2;253;50;79m_\033[39m\033[38;2;252;45;85m_\033[39m\033[38;2;251;40;91m_\033[39m\033[38;2;249;36;97m_\033[39m\033[38;2;247;31;104m/\033[39m\033[38;2;245;27;110m \033[39m\033[38;2;243;24;116m/\033[39m\033[38;2;240;20;122m_\033[39m\033[38;2;237;17;129m_\033[39m\033[38;2;233;14;135m/\033[39m\033[38;2;230;11;142m \033[39m\033[38;2;226;9;148m \033[39m\033[38;2;222;7;154m \033[39m\033[38;2;217;5;160m|\033[39m\033[38;2;213;3;166m \033[39m\033[38;2;208;2;172m \033[39m\033[38;2;203;1;178m_\033[39m\033[38;2;198;1;184m_\033[39m\033[38;2;192;1;190m_\033[39m\033[38;2;187;1;195m_\033[39m\033[38;2;181;1;200m \033[39m\033[38;2;175;2;205m \033[39m\033[38;2;169;3;210m_\033[39m\033[38;2;163;4;215m_\033[39m\033[38;2;157;6;220m_\033[39m\033[38;2;151;8;224m_\033[39m\033[38;2;145;10;228m \033[39m\033[38;2;138;12;232m_\033[39m\033[38;2;132;15;235m/\033[39m\033[38;2;126;18;238m \033[39m\033[38;2;119;22;241m/\033[39m\033[38;2;113;25;244m_\033[39m\033[38;2;107;29;246m \033[39m\033[38;2;101;33;248m \033[39m\033[38;2;94;38;250m_\033[39m\033[38;2;88;42;252m_\033[39m\033[38;2;82;47;253m_\033[39m\033[38;2;76;52;254m_\033[39m\033[38;2;71;57;254m_\033[39m\033[38;2;65;63;254m_\033[39m\033[38;2;60;68;254m \033[39m\033[38;2;54;74;254m \033[39m\033[38;2;49;80;253m_\033[39m\033[38;2;44;86;252m_\033[39m\033[38;2;40;92;251m_\033[39m\033[38;2;35;98;249m \033[39m\033[38;2;31;104;247m \033[39m\033[38;2;27;111;245m_\033[39m\033[38;2;23;117;242m_\033[39m\033[38;2;20;123;240m_\033[39m\033[38;2;16;130;236m_\033[39m\033[38;2;14;136;233m_\033[39m\033[38;2;11;142;229m\033[39m\n"      \
	"\033[38;2;215;163;4m \033[39m\033[38;2;219;157;6m \033[39m\033[38;2;224;151;8m\\\033[39m\033[38;2;228;145;10m_\033[39m\033[38;2;232;139;12m_\033[39m\033[38;2;235;132;15m \033[39m\033[38;2;238;126;18m\\\033[39m\033[38;2;241;120;22m/\033[39m\033[38;2;244;113;25m \033[39m\033[38;2;246;107;29m_\033[39m\033[38;2;248;101;33m_\033[39m\033[38;2;250;95;38m/\033[39m\033[38;2;252;88;42m \033[39m\033[38;2;253;82;47m_\033[39m\033[38;2;254;77;52m_\033[39m\033[38;2;254;71;57m \033[39m\033[38;2;254;65;63m`\033[39m\033[38;2;254;60;68m/\033[39m\033[38;2;254;54;74m \033[39m\033[38;2;253;49;80m_\033[39m\033[38;2;252;44;86m_\033[39m\033[38;2;251;40;92m_\033[39m\033[38;2;249;35;98m/\033[39m\033[38;2;247;31;104m \033[39m\033[38;2;245;27;110m/\033[39m\033[38;2;242;23;117m/\033[39m\033[38;2;240;20;123m_\033[39m\033[38;2;236;17;129m/\033[39m\033[38;2;233;14;136m \033[39m\033[38;2;229;11;142m/\033[39m\033[38;2;226;9;148m|\033[39m\033[38;2;221;6;155m \033[39m\033[38;2;217;5;161m|\033[39m\033[38;2;212;3;167m \033[39m\033[38;2;208;2;173m/\033[39m\033[38;2;202;1;179m \033[39m\033[38;2;197;1;185m_\033[39m\033[38;2;192;1;190m_\033[39m\033[38;2;186;1;196m \033[39m\033[38;2;181;1;201m\\\033[39m\033[38;2;175;2;206m/\033[39m\033[38;2;169;3;211m \033[39m\033[38;2;163;4;216m_\033[39m\033[38;2;157;6;220m_\033[39m\033[38;2;150;8;224m \033[39m\033[38;2;144;10;228m`\033[39m\033[38;2;138;13;232m/\033[39m\033[38;2;132;16;235m \033[39m\033[38;2;125;19;239m/\033[39m\033[38;2;119;22;242m \033[39m\033[38;2;112;26;244m/\033[39m\033[38;2;106;30;247m \033[39m\033[38;2;100;34;249m/\033[39m\033[38;2;94;38;250m \033[39m\033[38;2;88;43;252m/\033[39m\033[38;2;82;48;253m_\033[39m\033[38;2;76;53;254m \033[39m\033[38;2;70;58;254m \033[39m\033[38;2;65;63;254m/\033[39m\033[38;2;59;69;254m \033[39m\033[38;2;54;75;254m/\033[39m\033[38;2;49;81;253m \033[39m\033[38;2;44;86;252m_\033[39m\033[38;2;39;93;251m \033[39m\033[38;2;35;99;249m\\\033[39m\033[38;2;31;105;247m/\033[39m\033[38;2;27;111;245m \033[39m\033[38;2;23;118;242m_\033[39m\033[38;2;19;124;239m_\033[39m\033[38;2;16;130;236m_\033[39m\033[38;2;13;137;233m/\033[39m\033[38;2;11;143;229m\033[39m\n"  \
	"\033[38;2;215;163;4m \033[39m\033[38;2;220;157;6m_\033[39m\033[38;2;224;151;8m_\033[39m\033[38;2;228;144;10m_\033[39m\033[38;2;232;138;13m/\033[39m\033[38;2;235;132;16m \033[39m\033[38;2;239;125;19m/\033[39m\033[38;2;242;119;22m \033[39m\033[38;2;244;113;26m/\033[39m\033[38;2;247;106;30m_\033[39m\033[38;2;249;100;34m/\033[39m\033[38;2;250;94;38m \033[39m\033[38;2;252;88;43m/\033[39m\033[38;2;253;82;48m_\033[39m\033[38;2;254;76;53m/\033[39m\033[38;2;254;70;58m \033[39m\033[38;2;254;65;63m/\033[39m\033[38;2;254;59;69m \033[39m\033[38;2;254;54;75m/\033[39m\033[38;2;253;49;80m_\033[39m\033[38;2;252;44;86m_\033[39m\033[38;2;251;39;92m/\033[39m\033[38;2;249;35;99m \033[39m\033[38;2;247;31;105m,\033[39m\033[38;2;245;27;111m<\033[39m\033[38;2;242;23;117m \033[39m\033[38;2;239;19;124m/\033[39m\033[38;2;236;16;130m \033[39m\033[38;2;233;13;136m_\033[39m\033[38;2;229;11;143m_\033[39m\033[38;2;225;8;149m_\033[39m\033[38;2;221;6;155m \033[39m\033[38;2;217;5;161m|\033[39m\033[38;2;212;3;168m/\033[39m\033[38;2;207;2;173m \033[39m\033[38;2;202;1;179m/\033[39m\033[38;2;197;1;185m \033[39m\033[38;2;191;1;191m/\033[39m\033[38;2;186;1;196m \033[39m\033[38;2;180;1;201m/\033[39m\033[38;2;174;2;206m \033[39m\033[38;2;168;3;211m/\033[39m\033[38;2;162;4;216m_\033[39m\033[38;2;156;6;220m/\033[39m\033[38;2;150;8;225m \033[39m\033[38;2;144;10;229m/\033[39m\033[38;2;137;13;232m \033[39m\033[38;2;131;16;236m/\033[39m\033[38;2;125;19;239m \033[39m\033[38;2;118;22;242m/\033[39m\033[38;2;112;26;244m_\033[39m\033[38;2;106;30;247m/\033[39m\033[38;2;99;34;249m \033[39m\033[38;2;93;39;251m/\033[39m\033[38;2;87;43;252m \033[39m\033[38;2;81;48;253m/\033[39m\033[38;2;75;53;254m \033[39m\033[38;2;70;59;254m/\033[39m\033[38;2;64;64;254m_\033[39m\033[38;2;59;70;254m/\033[39m\033[38;2;53;75;254m \033[39m\033[38;2;48;81;253m \033[39m\033[38;2;43;87;252m_\033[39m\033[38;2;39;93;251m_\033[39m\033[38;2;34;99;249m/\033[39m\033[38;2;30;106;247m \033[39m\033[38;2;26;112;244m/\033[39m\033[38;2;22;118;242m \033[39m\033[38;2;19;124;239m \033[39m\033[38;2;16;131;236m \033[39m\033[38;2;13;137;232m \033[39m\033[38;2;10;143;229m\033[39m\n"       \
	"\033[38;2;216;162;4m/\033[39m\033[38;2;220;156;6m_\033[39m\033[38;2;225;150;8m_\033[39m\033[38;2;229;144;10m_\033[39m\033[38;2;232;137;13m_\033[39m\033[38;2;236;131;16m/\033[39m\033[38;2;239;125;19m\\\033[39m\033[38;2;242;118;22m_\033[39m\033[38;2;244;112;26m_\033[39m\033[38;2;247;106;30m/\033[39m\033[38;2;249;99;34m\\\033[39m\033[38;2;251;93;39m_\033[39m\033[38;2;252;87;43m_\033[39m\033[38;2;253;81;48m,\033[39m\033[38;2;254;75;53m_\033[39m\033[38;2;254;70;58m/\033[39m\033[38;2;254;64;64m\\\033[39m\033[38;2;254;59;69m_\033[39m\033[38;2;254;53;75m_\033[39m\033[38;2;253;48;81m_\033[39m\033[38;2;252;43;87m/\033[39m\033[38;2;251;39;93m_\033[39m\033[38;2;249;34;99m/\033[39m\033[38;2;247;30;105m|\033[39m\033[38;2;245;26;112m_\033[39m\033[38;2;242;23;118m/\033[39m\033[38;2;239;19;124m_\033[39m\033[38;2;236;16;131m/\033[39m\033[38;2;232;13;137m \033[39m\033[38;2;229;10;143m \033[39m\033[38;2;225;8;150m|\033[39m\033[38;2;220;6;156m_\033[39m\033[38;2;216;4;162m/\033[39m\033[38;2;211;3;168m_\033[39m\033[38;2;207;2;174m/\033[39m\033[38;2;201;1;180m \033[39m\033[38;2;196;1;186m/\033[39m\033[38;2;191;1;191m_\033[39m\033[38;2;185;1;197m/\033[39m\033[38;2;179;1;202m\\\033[39m\033[38;2;174;2;207m_\033[39m\033[38;2;168;3;212m_\033[39m\033[38;2;162;5;216m,\033[39m\033[38;2;155;6;221m_\033[39m\033[38;2;149;8;225m/\033[39m\033[38;2;143;11;229m_\033[39m\033[38;2;137;13;233m/\033[39m\033[38;2;130;16;236m\\\033[39m\033[38;2;124;19;239m_\033[39m\033[38;2;118;23;242m_\033[39m\033[38;2;111;27;245m,\033[39m\033[38;2;105;31;247m \033[39m\033[38;2;99;35;249m/\033[39m\033[38;2;93;39;251m \033[39m\033[38;2;87;44;252m/\033[39m\033[38;2;81;49;253m_\033[39m\033[38;2;75;54;254m_\033[39m\033[38;2;69;59;254m_\033[39m\033[38;2;63;65;254m/\033[39m\033[38;2;58;70;254m\\\033[39m\033[38;2;53;76;254m_\033[39m\033[38;2;48;82;253m_\033[39m\033[38;2;43;88;252m_\033[39m\033[38;2;38;94;250m/\033[39m\033[38;2;34;100;249m_\033[39m\033[38;2;30;106;247m/\033[39m\033[38;2;26;112;244m \033[39m\033[38;2;22;119;242m \033[39m\033[38;2;19;125;239m \033[39m\033[38;2;16;131;235m \033[39m\033[38;2;13;138;232m \033[39m\033[38;2;10;144;228m\033[39m\n" \
	"\033[38;2;216;162;4m \033[39m\033[38;2;221;155;6m \033[39m\033[38;2;225;149;8m \033[39m\033[38;2;229;143;11m \033[39m\033[38;2;233;137;13m \033[39m\033[38;2;236;130;16m \033[39m\033[38;2;239;124;19m \033[39m\033[38;2;242;118;23m \033[39m\033[38;2;245;111;27m \033[39m\033[38;2;247;105;30m \033[39m\033[38;2;249;99;35m \033[39m\033[38;2;251;93;39m \033[39m\033[38;2;252;87;44m \033[39m\033[38;2;253;81;49m \033[39m\033[38;2;254;75;54m \033[39m\033[38;2;254;69;59m \033[39m\033[38;2;254;64;64m \033[39m\033[38;2;254;58;70m \033[39m\033[38;2;254;53;76m \033[39m\033[38;2;253;48;82m \033[39m\033[38;2;252;43;88m \033[39m\033[38;2;250;38;94m \033[39m\033[38;2;249;34;100m \033[39m\033[38;2;247;30;106m \033[39m\033[38;2;244;26;112m \033[39m\033[38;2;242;22;119m \033[39m\033[38;2;239;19;125m \033[39m\033[38;2;235;16;131m \033[39m\033[38;2;232;13;138m \033[39m\033[38;2;228;10;144m \033[39m\033[38;2;224;8;150m \033[39m\033[38;2;220;6;157m \033[39m\033[38;2;216;4;163m \033[39m\033[38;2;211;3;169m \033[39m\033[38;2;206;2;175m \033[39m\033[38;2;201;1;181m \033[39m\033[38;2;196;1;186m \033[39m\033[38;2;190;1;192m \033[39m\033[38;2;185;1;197m \033[39m\033[38;2;179;1;202m \033[39m\033[38;2;173;2;207m \033[39m\033[38;2;167;3;212m \033[39m\033[38;2;161;5;217m \033[39m\033[38;2;155;6;221m \033[39m\033[38;2;149;9;225m \033[39m\033[38;2;142;11;229m \033[39m\033[38;2;136;14;233m/\033[39m\033[38;2;130;16;236m_\033[39m\033[38;2;123;20;240m_\033[39m\033[38;2;117;23;242m_\033[39m\033[38;2;111;27;245m_\033[39m\033[38;2;104;31;247m/\033[39m\033[38;2;98;35;249m \033[39m\033[38;2;92;40;251m \033[39m\033[38;2;86;44;252m \033[39m\033[38;2;80;49;253m \033[39m\033[38;2;74;54;254m \033[39m\033[38;2;68;60;254m \033[39m\033[38;2;63;65;254m \033[39m\033[38;2;58;71;254m \033[39m\033[38;2;52;76;254m \033[39m\033[38;2;47;82;253m \033[39m\033[38;2;42;88;252m \033[39m\033[38;2;38;94;250m \033[39m\033[38;2;33;101;248m \033[39m\033[38;2;29;107;246m \033[39m\033[38;2;25;113;244m \033[39m\033[38;2;22;119;241m \033[39m\033[38;2;18;126;238m \033[39m\033[38;2;15;132;235m \033[39m\033[38;2;12;138;232m \033[39m\033[38;2;10;145;228m\033[39m"

#define COLLECTOR_INFO(_name) _BLUE "\b\b\b\bCollector for " _name " trace" _RE

inline void clearSpace(char *sym)
{
	for (char *p = sym; *p; p++)
	{
		if (*p != ' ')
		{
			*sym = *p;
			sym++;
		}
	}
	*sym = '\0';
}

#endif
